name: Generate Duck Scale Image

# on:
#   workflow_dispatch:
#     inputs:
#       description:
#         description: 'Duck scale theme/description'
#         required: true
#         type: string
#       user:
#         description: 'User who requested the duck scale'
#         required: false
#         default: 'unknown'
#         type: string

jobs:
  generate-duck-scale:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Edit Image with OpenAI
        id: generate
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DESCRIPTION: ${{ inputs.description }}
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          FILENAME="duck-scale-${TIMESTAMP}.png"

          # Create the prompt for editing the duck scale image
          PROMPT="Edit this duck scale image. Replace the rubber ducks with: ${DESCRIPTION}. Keep the same 3x3 grid layout with numbers 1-9. Square 1 should show the subject happy and cheerful, gradually becoming sadder until square 9 which shows the subject completely sad and deflated. Maintain the mood scale concept but with the new subject."

          echo "Editing duck scale with description: $DESCRIPTION"

          # Call OpenAI Image Edit API with multipart form data
          RESPONSE=$(curl -s -X POST "https://api.openai.com/v1/images/edits" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -F "model=gpt-image-1" \
            -F "image=@duck_scale.jpeg" \
            -F "prompt=$PROMPT" \
            -F "size=1024x1024")

          echo "API Response received"

          # Check for errors
          ERROR=$(echo "$RESPONSE" | jq -r '.error.message // empty')
          if [ -n "$ERROR" ]; then
            echo "Error from OpenAI API: $ERROR"
            echo "Full response: $RESPONSE"
            exit 1
          fi

          # Extract base64 image data
          IMAGE_B64=$(echo "$RESPONSE" | jq -r '.data[0].b64_json // empty')

          if [ -n "$IMAGE_B64" ] && [ "$IMAGE_B64" != "null" ]; then
            echo "$IMAGE_B64" | base64 -d > "duck-scales/$FILENAME"
          else
            echo "No image data found in response"
            echo "Full response: $RESPONSE"
            exit 1
          fi

          echo "Image saved to duck-scales/$FILENAME"
          echo "filename=$FILENAME" >> $GITHUB_OUTPUT

      - name: Commit and Push Image
        env:
          DESCRIPTION: ${{ inputs.description }}
          USER: ${{ inputs.user }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add duck-scales/
          git commit -m "Add duck scale image: ${{ steps.generate.outputs.filename }}

          Requested by: ${USER}
          Description: ${DESCRIPTION}"
          git push

      - name: Get Image URL
        id: image_url
        run: |
          FILENAME="${{ steps.generate.outputs.filename }}"
          IMAGE_URL="https://raw.githubusercontent.com/${{ github.repository }}/main/duck-scales/${FILENAME}"
          echo "url=$IMAGE_URL" >> $GITHUB_OUTPUT
          echo "Image URL: $IMAGE_URL"

      - name: Notify Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          IMAGE_URL: ${{ steps.image_url.outputs.url }}
        run: |
          # Build JSON payload for Slack workflow webhook
          SLACK_PAYLOAD=$(jq -n --arg url "$IMAGE_URL" '{duck_scale_url: $url}')

          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$SLACK_PAYLOAD"

          echo "Slack workflow webhook called with: $SLACK_PAYLOAD"
