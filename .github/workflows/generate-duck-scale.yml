name: Generate Duck Scale Image

on:
  workflow_dispatch:
    inputs:
      description:
        description: 'Duck scale theme/description'
        required: true
        type: string
      user:
        description: 'User who requested the duck scale'
        required: false
        default: 'unknown'
        type: string

jobs:
  generate-duck-scale:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clean up description
        id: cleanup
        env:
          RAW_DESCRIPTION: ${{ inputs.description }}
        run: |
          # Strip common prefixes like "duck scale it:", "duck scale a", "duck scale"
          CLEAN=$(echo "$RAW_DESCRIPTION" | sed -E 's/^duck scale (it:?|a|an|the|me)?\s*//i' | xargs)
          echo "Cleaned description: $CLEAN"
          echo "description=$CLEAN" >> $GITHUB_OUTPUT

      - name: Edit Image with OpenAI
        id: generate
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DESCRIPTION: ${{ steps.cleanup.outputs.description }}
          USER: ${{ inputs.user }}
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          # Sanitize description and user for filename (lowercase, replace spaces/special chars with dashes)
          SAFE_DESC=$(echo "$DESCRIPTION" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//' | cut -c1-30)
          SAFE_USER=$(echo "$USER" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//')
          FILENAME="${SAFE_DESC}-${SAFE_USER}-${TIMESTAMP}.png"

          # Create the optimized prompt for editing the duck scale image
          PROMPT="You are editing the provided image, which is a 3×3 photo collage with panels numbered 1–9.
          Preserve the collage EXACTLY: same 3×3 grid layout, same panel order, same borders, same backgrounds, same camera angles, and keep the existing numbers 1–9 in the same positions and style. Do not add any new text, captions, watermarks, or logos.

          Only change ONE thing: replace the large inflatable rubber duck in every panel with a giant inflatable float shaped like: ${DESCRIPTION}.

          Interpretation rules for the subject:
          - Always depict it as a GIANT INFLATABLE PVC/VINYL parade-style float (shiny plastic, seams, valve, realistic wrinkles when deflated).
          - Keep the subject design consistent across all 9 panels (same colors, face/details, proportions). Do NOT change the subject's identity between panels.
          - If the subject is an animal/person/concept, render it as a stylized inflatable sculpture/float (not a real living animal/person).

          Deflation / mood progression (match the original staging):
          1) Fully inflated, upright, cheerful/energetic.
          2) Fully inflated, calm/neutral.
          3) Slightly underinflated, leaning a bit, minor sagging.
          4) Noticeably sagging, more wrinkles, less perky.
          5) Heavily wrinkled, slumped, losing structure.
          6) Mostly collapsed, lying on its side in the water.
          7) Nearly empty, head/face drooping downward.
          8) Almost fully deflated on land (keep the crowd/setting as in the original).
          9) Completely spent: almost flat, partially submerged/pressed down.

          Photorealistic. Match the lighting and realism of the original photo collage."

          echo "Editing duck scale with description: $DESCRIPTION"

          # Call OpenAI Image Edit API with mask for maximum preservation
          RESPONSE=$(curl -s -X POST "https://api.openai.com/v1/images/edits" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -F "model=gpt-image-1" \
            -F "image=@duck_scale.jpeg" \
            -F "mask=@duck_scale_mask.png" \
            --form-string "prompt=$PROMPT" \
            -F "input_fidelity=high" \
            -F "quality=high" \
            -F "size=1024x1024")

          echo "API Response received"

          # Check for errors
          ERROR=$(echo "$RESPONSE" | jq -r '.error.message // empty')
          if [ -n "$ERROR" ]; then
            echo "Error from OpenAI API: $ERROR"
            echo "Full response: $RESPONSE"
            exit 1
          fi

          # Extract base64 image data
          IMAGE_B64=$(echo "$RESPONSE" | jq -r '.data[0].b64_json // empty')

          if [ -n "$IMAGE_B64" ] && [ "$IMAGE_B64" != "null" ]; then
            echo "$IMAGE_B64" | base64 -d > "duck-scales/$FILENAME"
          else
            echo "No image data found in response"
            echo "Full response: $RESPONSE"
            exit 1
          fi

          echo "Image saved to duck-scales/$FILENAME"
          echo "filename=$FILENAME" >> $GITHUB_OUTPUT

      - name: Commit and Push Image
        env:
          DESCRIPTION: ${{ steps.cleanup.outputs.description }}
          USER: ${{ inputs.user }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add duck-scales/
          git commit -m "Add duck scale image: ${{ steps.generate.outputs.filename }}

          Requested by: ${USER}
          Description: ${DESCRIPTION}"
          git push

      - name: Get Image URL
        id: image_url
        run: |
          FILENAME="${{ steps.generate.outputs.filename }}"
          IMAGE_URL="https://raw.githubusercontent.com/${{ github.repository }}/main/duck-scales/${FILENAME}"
          echo "url=$IMAGE_URL" >> $GITHUB_OUTPUT
          echo "Image URL: $IMAGE_URL"

      - name: Notify Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          IMAGE_URL: ${{ steps.image_url.outputs.url }}
          USER: ${{ inputs.user }}
          DESCRIPTION: ${{ steps.cleanup.outputs.description }}
        run: |
          # Build JSON payload for Slack workflow webhook
          SLACK_PAYLOAD=$(jq -n \
            --arg url "$IMAGE_URL" \
            --arg user "$USER" \
            --arg desc "$DESCRIPTION" \
            '{duck_scale_url: $url, requested_by_user: $user, duck_scale_description: $desc}')

          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$SLACK_PAYLOAD"

          echo "Slack workflow webhook called with: $SLACK_PAYLOAD"
