name: Generate Duck Scale Image

on:
  workflow_dispatch:
    inputs:
      description:
        description: 'Duck scale theme/description'
        required: true
        type: string
      user:
        description: 'User who requested the duck scale'
        required: false
        default: 'unknown'
        type: string

jobs:
  generate-duck-scale:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clean up description
        id: cleanup
        env:
          RAW_DESCRIPTION: ${{ inputs.description }}
        run: |
          # Strip common prefixes like "duck scale it:", "duck scale a", "duck scale"
          CLEAN=$(echo "$RAW_DESCRIPTION" | sed -E 's/^duck scale (it:?|a|an|the|me)?\s*//i' | xargs)
          echo "Cleaned description: $CLEAN"
          echo "description=$CLEAN" >> $GITHUB_OUTPUT

      - name: Edit Image with OpenAI
        id: generate
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DESCRIPTION: ${{ steps.cleanup.outputs.description }}
          USER: ${{ inputs.user }}
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          # Sanitize description and user for filename (lowercase, replace spaces/special chars with dashes)
          SAFE_DESC=$(echo "$DESCRIPTION" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//' | cut -c1-30)
          SAFE_USER=$(echo "$USER" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//')
          FILENAME="${SAFE_DESC}-${SAFE_USER}-${TIMESTAMP}.png"

          # Ensure output directory exists
          mkdir -p duck-scales

          # Create the optimized prompt for editing the duck scale image using heredoc
          # (safer than double-quoted string if description contains quotes/special chars)
          PROMPT=$(cat <<EOF
You are editing the provided image, a 3×3 real-life photo collage with panels numbered 1–9.
Preserve EVERYTHING about the collage: same 3×3 grid, same panel order, same crops, same backgrounds, same lighting, same camera angles, and keep the existing numbers 1–9 exactly as-is (same placement/style). Do not add any new text, captions, watermarks, or logos.

Only edit the inflatable subject inside each panel: replace the giant inflatable rubber duck with a giant inflatable vinyl/PVC float shaped like: ${DESCRIPTION}.
The replacement must look like a real inflatable festival float (shiny vinyl, seams, valve, realistic wrinkles when losing air), not a real animal/person.

Critical: match the ORIGINAL COMPOSITION per panel.
- Keep the subject's position in the frame, orientation (side view vs front view), scale, and the waterline/shoreline exactly like the duck in that same panel.
- Keep all non-subject objects unchanged (trees, shoreline, water reflections, people, and the small green boat/raft visible in some panels). Do not alter them.

Keep the replacement subject design consistent across all 9 panels (same colors/details/proportions), just changing inflation level and pose.

Panel-by-panel match (1→9):
1) Fully inflated, towering, clean side profile facing right, clear blue-sky backdrop.
2) Fully inflated, front-facing and centered, upright.
3) Slightly underinflated while floating; base slumps; preserve the small green boat/raft in front.
4) Noticeably deflated; side view; visible sagging and wrinkles.
5) Close-up angle; heavy vertical wrinkles down the neck/body area.
6) Mostly collapsed; lying on its side on the water; head tilted down.
7) Very low/sunk in the water; face-on; only upper head/eyes and beak prominent near the water surface.
8) Nearly fully deflated on land as a large mound; preserve the people/crowd in the foreground unchanged.
9) Completely deflated/flattened floating; head sideways partially submerged; preserve the small green boat/raft resting against/on it.

Photorealistic. Match the realism and lighting of each original photo panel.
EOF
          )

          echo "Editing duck scale with description: $DESCRIPTION"

          # Call OpenAI Image Edit API with mask for maximum preservation
          # --fail-with-body ensures HTTP errors cause failure while still capturing response body
          RESPONSE=$(curl -sS --fail-with-body -X POST "https://api.openai.com/v1/images/edits" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -F "model=gpt-image-1" \
            -F "image=@duck_scale.jpeg" \
            -F "mask=@duck_scale_mask.png" \
            --form-string "prompt=$PROMPT" \
            -F "input_fidelity=high" \
            -F "quality=high" \
            -F "size=1024x1024" \
            -F "user=$SAFE_USER")

          echo "API Response received"

          # Check for errors
          ERROR=$(echo "$RESPONSE" | jq -r '.error.message // empty')
          if [ -n "$ERROR" ]; then
            echo "Error from OpenAI API: $ERROR"
            echo "Full response: $RESPONSE"
            exit 1
          fi

          # Extract base64 image data
          IMAGE_B64=$(echo "$RESPONSE" | jq -r '.data[0].b64_json // empty')

          if [ -n "$IMAGE_B64" ] && [ "$IMAGE_B64" != "null" ]; then
            echo "$IMAGE_B64" | base64 -d > "duck-scales/$FILENAME"
          else
            echo "No image data found in response"
            echo "Full response: $RESPONSE"
            exit 1
          fi

          echo "Image saved to duck-scales/$FILENAME"
          echo "filename=$FILENAME" >> $GITHUB_OUTPUT

      - name: Commit and Push Image
        env:
          DESCRIPTION: ${{ steps.cleanup.outputs.description }}
          USER: ${{ inputs.user }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add duck-scales/
          git commit -m "Add duck scale image: ${{ steps.generate.outputs.filename }}

          Requested by: ${USER}
          Description: ${DESCRIPTION}"
          git push

      - name: Get Image URL
        id: image_url
        run: |
          FILENAME="${{ steps.generate.outputs.filename }}"
          IMAGE_URL="https://raw.githubusercontent.com/${{ github.repository }}/main/duck-scales/${FILENAME}"
          echo "url=$IMAGE_URL" >> $GITHUB_OUTPUT
          echo "Image URL: $IMAGE_URL"

      - name: Notify Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          IMAGE_URL: ${{ steps.image_url.outputs.url }}
          USER: ${{ inputs.user }}
          DESCRIPTION: ${{ steps.cleanup.outputs.description }}
        run: |
          # Build JSON payload for Slack workflow webhook
          SLACK_PAYLOAD=$(jq -n \
            --arg url "$IMAGE_URL" \
            --arg user "$USER" \
            --arg desc "$DESCRIPTION" \
            '{duck_scale_url: $url, requested_by_user: $user, duck_scale_description: $desc}')

          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$SLACK_PAYLOAD"

          echo "Slack workflow webhook called with: $SLACK_PAYLOAD"
